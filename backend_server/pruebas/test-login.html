<!DOCTYPE html>
<html>
<head>
    <title>Test Login</title>
    <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .disconnected { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }
        #messages { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h2>Registro</h2>
    <form id="registerForm">
        <input type="text" id="nombreUser" placeholder="Nombre usuario" required><br><br>
        <input type="email" id="correo" placeholder="Correo" required><br><br>
        <input type="password" id="contrasena" placeholder="Contrase√±a" required><br><br>
        <button type="submit">Registrarse</button>
    </form>

    <h2>Reenviar Verificaci√≥n</h2>
    <form id="resendForm">
        <input type="email" id="resendCorreo" placeholder="Correo" required><br><br>
        <button type="submit">Reenviar Verificaci√≥n</button>
    </form>

    <h2>Login</h2>
    <form id="loginForm">
        <input type="text" id="loginNombreUser" placeholder="Nombre de usuario" required><br><br>
        <input type="password" id="loginContrasena" placeholder="Contrase√±a" required><br><br>
        <button type="submit">Iniciar Sesi√≥n</button>
    </form>

    <h2>Logout</h2>
    <form id="logoutForm">
        <input type="text" id="logoutNombreUser" placeholder="Nombre de usuario" required><br><br>
        <button type="submit">Cerrar Sesi√≥n</button>
    </form>

    <hr>
    <h2>üîå WebSocket Connection</h2>
    <div id="connectionStatus" class="status disconnected">
        ‚ùå Desconectado - Haz login para conectar via WebSocket
    </div>
    
    <h3>üì® Mensajes del Servidor</h3>
    <div id="messages"></div>
    
    <h3>üì§ Enviar Mensaje de Prueba</h3>
    <input type="text" id="testMessage" placeholder="Escribe un mensaje..." disabled>
    <button id="sendMessage" disabled>Enviar</button>

    <script>
        // Variables globales para WebSocket
        let socket = null;
        let currentToken = null;
        let currentUser = null;

        // Funciones WebSocket
        function connectWebSocket(token, username) {
            if (socket) {
                socket.disconnect();
            }

            currentToken = token;
            currentUser = username;
            
            // Conectar con el token como query parameter
            socket = io('http://localhost:8080', {
                query: { token: token }
            });

            // Event listeners
            socket.on('connect', () => {
                console.log('‚úÖ Conectado via WebSocket');
                updateConnectionStatus('connected', `‚úÖ Conectado como ${username}`);
                document.getElementById('testMessage').disabled = false;
                document.getElementById('sendMessage').disabled = false;
            });

            socket.on('disconnect', () => {
                console.log('‚ùå Desconectado del WebSocket');
                updateConnectionStatus('disconnected', '‚ùå Desconectado');
                document.getElementById('testMessage').disabled = true;
                document.getElementById('sendMessage').disabled = true;
            });

            socket.on('ping', (data) => {
                addMessage('üì° Ping del servidor: ' + data.message);
                // Responder con pong
                socket.emit('pong', { message: 'Pong desde cliente!' });
            });

            socket.on('connect_error', (error) => {
                console.error('Error de conexi√≥n:', error);
                addMessage('‚ùå Error de conexi√≥n: ' + error.message);
            });
        }

        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${status}`;
            statusDiv.textContent = message;
        }

        function addMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Event listener para enviar mensajes de prueba
        document.getElementById('sendMessage').onclick = () => {
            const message = document.getElementById('testMessage').value;
            if (message && socket) {
                socket.emit('test-message', { message: message, from: currentUser });
                addMessage('üì§ Enviado: ' + message);
                document.getElementById('testMessage').value = '';
            }
        };

        // Registro
        document.getElementById('registerForm').onsubmit = async (e) => {
            e.preventDefault();
            const response = await fetch('http://localhost:8080/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    NombreUser: document.getElementById('nombreUser').value,
                    Correo: document.getElementById('correo').value,
                    Contrasena: document.getElementById('contrasena').value
                })
            });
            const result = await response.json();
            alert(JSON.stringify(result));
        };

        // Reenviar verificaci√≥n
        document.getElementById('resendForm').onsubmit = async (e) => {
            e.preventDefault();
            const response = await fetch('http://localhost:8080/resendVerification', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    Correo: document.getElementById('resendCorreo').value
                })
            });
            const result = await response.json();
            alert(JSON.stringify(result));
        };

        // Login
        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginNombreUser').value;
            
            const response = await fetch('http://localhost:8080/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    NombreUser: username,
                    Contrasena: document.getElementById('loginContrasena').value
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.accessToken) {
                // Login exitoso - conectar WebSocket
                alert('‚úÖ Login exitoso! Conectando WebSocket...');
                connectWebSocket(result.accessToken, username);
                addMessage(`üîë Login exitoso como ${username}`);
                
                // Auto-rellenar el campo de logout
                document.getElementById('logoutNombreUser').value = username;
            } else {
                // Login fallido
                alert('‚ùå Login fallido: ' + JSON.stringify(result));
            }
        };

        // Logout
        document.getElementById('logoutForm').onsubmit = async (e) => {
            e.preventDefault();
            const response = await fetch('http://localhost:8080/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    NombreUser: document.getElementById('logoutNombreUser').value
                })
            });
            const result = await response.text(); // El logout devuelve texto, no JSON
            
            // Desconectar WebSocket
            if (socket) {
                socket.disconnect();
                socket = null;
                currentToken = null;
                currentUser = null;
            }
            
            addMessage('üîì Logout realizado');
            updateConnectionStatus('disconnected', '‚ùå Desconectado');
            
            alert(result);
        };
    </script>
</body>
</html>